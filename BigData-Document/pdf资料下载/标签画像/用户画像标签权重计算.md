# 标签权重的理论基础
用户画像：即用户信息标签化，通过收集用户社会属性、消费习惯、偏好特征等各个维度数据，进而对用户或者产品特征属性的刻画，并对这些特征分析统计挖掘潜在价值信息，从而抽象出一个用户的信息全貌，可看做是企业应用大数据的根基，是定向广告投放与个性化推荐的前置条件。
![](https://files.mdnice.com/user/37771/b429bf95-9c6e-4d23-86d4-a2fdcb893340.png)
然而对于不同的标签使用频度和重要性也是不一样的，而在此我们需要根据用户的标签打上一个相关的标签权重值。该权重影响着对用户属性的归类，属性归类不准确，接下来基于画像对用户进行推荐、营销的准确性也就无从谈起了。

标签权重的计算公式：

```
用户行为标签的权重=行为类型权重×时间衰减×TF-IDF标签权重×用户行为次数。
其中：行为类型权重×时间衰减 反应了标签的客观重要程度
     TF-IDF标签权重×用户行为次数 反应了标签对此用户的重要程度
     
行为类型权重：用户浏览、搜索、收藏、下单、购买等不同行 为对用户而言有着不同的重要性。一般而言，操作复杂度越高的行为 权重越大。该权重值一般由运营人员或数据分析人员主观给出。
时间衰减：用户某些行为受时间影响不断减弱，行为时间距现 在越远，该行为对用户当前行为来说意义越小。
行为次数：用户标签权重按天统计，用户某天与该标签产生的 行为次数越多，该标签对用户的影响越大。
TF-IDF计算标签权重：由每个标签对用户的重要性与该标签在 全体标签中的重要性的乘积得出每个标签的客观权重值。    
```
![](https://files.mdnice.com/user/37771/f63bae15-15bd-4ffe-8233-8eb640b77f31.png)
**tfidf：**
(用户身上每个标签个数/用户身上标签总数)*(log10(所有标签的总数/每个标签在全体标签中共有多少个))

![](https://files.mdnice.com/user/37771/bf4130d5-ba72-46da-b163-df5ea656d12c.png)
![](https://files.mdnice.com/user/37771/efee3812-2537-4ab8-9ded-b761e063b2f6.png)
一般来说：
行为权重 act_weight_plan_detail
![](https://files.mdnice.com/user/37771/4409d5fe-cc21-4e00-bb51-620c4d57c89c.png)
**行为类型权重**，付款权重>签约权重>下单权重>浏览权重 具体权重值根据运营经验设定调整

**行为时间** ，行为日期越近权重越大，行为日期越久远，权重越小，形成时间衰减效应

```
F(t) =初始值×exp( -衰减系统×间隔的时间)
```
用户某些行为会随时间衰减，而某些行为不会随时间衰减。一般用户行为的复杂程度越高，其随时间衰减的影响性越小

# 案例背景
通过一个金融投资的用户画像案例来展示如何结合业务需求和应用场景建立用户画像标签体系。

用户在某平台购买金融理财产品。平台捕捉到了的用户浏览产品、下单、签约、付款行为。通过对用户行为和用户购买记录分析用户的产品偏好，向用户推荐关联产品。通过精准的产品推荐，更好的提高用户的投资额。

**确定目标**

分析用户（customer）对产品（tag）的偏好程度和产品1（tag1）与产品2（tag2）之间的关联度，根据用户A偏好产品1，产品1（tag1）与产品2（tag2）高度关联，从而向用户A推荐产品2（tag2)。

`第一步：建立用户行为标签集合`

从背景中提炼用户信息维度，用户（customer）行为（act）了产品（tag）。形成用户行为标签，其中行为类型：浏览、下单、签约、付款。

从相应的基础数据中抽取相关行为数据，以天为单位进行行为统计，建立用户行为标签。

记录用户每一次操作形成的标签的明细数据，每天增量更新昨天产生的数据，增量更新保证用户所有历史行为的全量记录。
![](https://files.mdnice.com/user/37771/3e9ad0c2-df7d-4a53-bd14-80153e21d986.png)
![](https://files.mdnice.com/user/37771/e5353d6b-87be-4ef7-8fab-33bfef33865a.png)
`第二步：应用TF-IDF算法计算标签权重`
![](https://files.mdnice.com/user/37771/ff2a1719-7d9e-4181-9630-fc9c1cde191d.png)

```

/***计算每个用户每个标签的数量和每个用户的总标签数量写入tag_weight_of_tfidf_tf***/
drop table if exists tag_weight_of_tfidf_tf;
create table tag_weight_of_tfidf_tf
select p1.customer_key,p1.tag_key,p1.tag_name,p1.weight_m_p,p2.weight_m_s 
from
(select customer_key,
tag_key,
tag_name,
count(tag_key) as weight_m_p -- 用户身上每个标签个数
 from person_user_tag_relation_detail  group by customer_key, tag_key,tag_name) p1
left join
(select customer_key,
count(tag_key) as weight_m_s -- 用户身上标签总数
from person_user_tag_relation_detail group by customer_key) p2
on p1.customer_key = p2.customer_key
group by p1.customer_key,p1.tag_key,p1.tag_name,p1.weight_w_p,p2.weight_w_s
order by customer_key,tag_key;
```
![](https://files.mdnice.com/user/37771/2eb5c69a-98f6-4606-8017-0ed90d591794.png)

```
/***在tf的基础上计算每个标签的数量和总标签数量写入tag_weight_of_tfidf_idf***/
/*insert into tag_weight_of_tfidf_idf (tag_key,tag_name,weight_w_p,weight_w_s)**/
drop table if exists tag_weight_of_tfidf_idf;
create table tag_weight_of_tfidf_idf
select t1.tag_key,t1.tag_name,t1.weight_w_p,t2.weight_w_s
from
(select tag_key,tag_name,
sum(weight_m_p) as weight_w_p -- 每个标签在全体标签中共有多少个
from tag_weight_of_tfidf_tf 
group by tag_key,tag_name) t1
cross join 
(select sum(weight_m_p) as weight_w_s -- 所有标签的总数 
 from tag_weight_of_tfidf_tf) t2;
```
![](https://files.mdnice.com/user/37771/cc73a4df-f82d-4d30-a7df-90eac2889862.png)

```
/***在tf和idf的基础上计算每个用户身上的标签权重ratio写入tag_weight_of_tfidf***/
/*insert into tag_weight_of_tfidf(customer_key,tag_key,tag_name,ratio)*/
drop table if exists tag_weight_of_tfidf;
create table tag_weight_of_tfidf
select tf.customer_key,tf.tag_key,tf.tag_name,
(tf.weight_m_p/tf.weight_m_s)*(log10(idf.weight_w_s/idf.weight_w_p)) as ratio
from
 tag_weight_of_tfidf_tf tf left join tag_weight_of_tfidf_idf idf
 on tf.tag_key = idf.tag_key
 group by tf.customer_key,tf.tag_key,tf.tag_name,(tf.weight_m_p/tf.weight_m_s)*(log10(idf.weight_w_s/idf.weight_w_p)) -- 为什么要group by
 order by tf.customer_key,tf.tag_key;
```
`第三步：代入公式，行为类型权重×时间衰减×TF-IDF标签权重×用户行为次数进行计算，得到最终结果`

```
/**计算用户标签权重写入person_user_tag_relation_weight**/
insert into person_user_tag_relation_weight(customer_key,tag_key,tag_name,tag_type_key,act_type_key,cnt,date_key,db_date,act_weight)
select rp.customer_key,rp.tag_key,rp.tag_name,tag_type_key,rp.act_type_key,rp.cnt,rp.date_key,rp.db_date,
case 
when  dp.is_time_reduce = 1 then  -- 随时间衰减行为 
round(exp(datediff('2020-03-13',rp.db_date)*(-0.1556)) * dp.act_weight_detail * rp.cnt * tf.ratio ,4) -- 0.1556 为时间衰减系数，具体值待测定,保留4位小数
when dp.is_time_reduce = 0 then
round(dp.act_weight_detail * rp.cnt * tf.ratio,4) -- 不随时间衰减行为
end as act_weight
from person_user_tag_relation_detail rp -- 用户行为标签表
inner join act_weight_plan_detail dp -- 行为权重维表
on rp.act_type_key = dp.act_type_key -- 通过行为类型关联
inner join tag_weight_of_tfidf tf -- TF-IDF标签权重表
on (rp.customer_key = tf.customer_key and rp.tag_key = tf.tag_key) -- 用户key和标签key两个字段做主键关联
where rp.date_key < 20200313 -- 20200313 为当前日期
group by rp.customer_key,rp.tag_key,rp.tag_name,rp.tag_type_key,rp.act_type_key,rp.cnt,rp.db_date,
case when dp.is_time_reduce = 1 then exp(datediff('2020-03-13',rp.db_date)*(-0.1556))*dp.act_weight_detail * rp.cnt * tf.ratio
when dp.is_time_reduce = 0 then
dp.act_weight_detail * rp.cnt * tf.ratio end
order by rp.customer_key,rp.tag_key;
```
![](https://files.mdnice.com/user/37771/71fbbe8e-7625-448b-a4f8-000530290a24.png)

	